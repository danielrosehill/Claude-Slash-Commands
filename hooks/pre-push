#!/bin/bash

# Pre-push hook to sync slash commands and generate index
# Runs sync-commands.sh and generate_index.py before pushing

echo "Running pre-push checks..."
echo ""

# Get the repository root directory
REPO_ROOT="$(git rev-parse --show-toplevel)"

# Track if any updates were made
updates_made=false

# Run the sync script
if [ -f "${REPO_ROOT}/sync-commands.sh" ]; then
    echo "1. Running sync-commands.sh..."
    bash "${REPO_ROOT}/sync-commands.sh"
    sync_exit_code=$?

    if [ $sync_exit_code -ne 0 ]; then
        echo "✗ Sync failed with exit code $sync_exit_code"
        echo "Push aborted. Fix the sync issues and try again."
        exit 1
    fi
    echo "✓ Sync complete"
    echo ""
else
    echo "⚠ Warning: sync-commands.sh not found at ${REPO_ROOT}"
    echo ""
fi

# Run the index generation script
if [ -f "${REPO_ROOT}/scripts/generate_index.py" ]; then
    echo "2. Generating command index..."
    python3 "${REPO_ROOT}/scripts/generate_index.py"
    index_exit_code=$?

    if [ $index_exit_code -ne 0 ]; then
        echo "✗ Index generation failed with exit code $index_exit_code"
        echo "Push aborted. Fix the index generation issues and try again."
        exit 1
    fi

    # Check if README.md or INDEX.md were modified
    if ! git diff --quiet README.md INDEX.md 2>/dev/null; then
        echo ""
        echo "⚠ Index files were updated. Staging changes..."
        git add README.md INDEX.md
        updates_made=true
        echo "✓ Changes staged"
        echo ""
        echo "⚠ IMPORTANT: The index has been updated and staged."
        echo "   Please commit these changes before pushing:"
        echo "   git commit -m 'Update command index'"
        echo ""
        echo "Push aborted to allow you to commit the index updates."
        exit 1
    else
        echo "✓ Index is up to date"
    fi
    echo ""
else
    echo "⚠ Warning: generate_index.py not found at ${REPO_ROOT}/scripts/"
    echo ""
fi

echo "✓ All pre-push checks passed, proceeding with push..."
exit 0
